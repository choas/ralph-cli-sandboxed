# Ralph CLI Sandbox Environment
# Based on Claude Code devcontainer
# Generated by ralph-cli

FROM node:20-bookworm

ARG DEBIAN_FRONTEND=noninteractive
ARG TZ=UTC
ARG CLAUDE_CODE_VERSION="latest"
ARG ZSH_IN_DOCKER_VERSION="1.2.1"

# Set timezone
ENV TZ=${TZ}
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    nano \
    vim \
    less \
    procps \
    sudo \
    man-db \
    unzip \
    gnupg2 \
    jq \
    fzf \
    iptables \
    ipset \
    iproute2 \
    dnsutils \
    zsh \
    && rm -rf /var/lib/apt/lists/*

# Setup zsh with oh-my-zsh and plugins (no theme, we set custom prompt)
RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v${ZSH_IN_DOCKER_VERSION}/zsh-in-docker.sh)" -- \
    -t "" \
    -p git \
    -p fzf \
    -a "source /usr/share/doc/fzf/examples/key-bindings.zsh 2>/dev/null || true" \
    -a "source /usr/share/doc/fzf/examples/completion.zsh 2>/dev/null || true" \
    -a "export HISTFILE=/commandhistory/.zsh_history" \
    -a 'alias ll="ls -la"'

# Set custom prompt for node user (after oh-my-zsh to avoid override)
RUN cp -r /root/.oh-my-zsh /home/node/.oh-my-zsh && chown -R node:node /home/node/.oh-my-zsh && \
    cp /root/.zshrc /home/node/.zshrc && chown node:node /home/node/.zshrc && \
    sed -i 's|/root/.oh-my-zsh|/home/node/.oh-my-zsh|g' /home/node/.zshrc && \
    echo 'PROMPT="%K{yellow}%F{black}[ralph]%f%k%K{yellow}%F{black}%d%f%k\$ "' >> /home/node/.zshrc && \
    echo '' >> /home/node/.zshrc && \
    echo '# Ralph ASCII art banner' >> /home/node/.zshrc && \
    echo 'if [ -z "$RALPH_BANNER_SHOWN" ]; then' >> /home/node/.zshrc && \
    echo '  export RALPH_BANNER_SHOWN=1' >> /home/node/.zshrc && \
    echo '  echo ""' >> /home/node/.zshrc && \
    echo '  echo " ____      _    _     ____  _   _ "' >> /home/node/.zshrc && \
    echo '  echo "|  _ \\    / \\  | |   |  _ \\| | | |"' >> /home/node/.zshrc && \
    echo '  echo "| |_) |  / _ \\ | |   | |_) | |_| |"' >> /home/node/.zshrc && \
    echo '  echo "|  _ <  / ___ \\| |___|  __/|  _  |"' >> /home/node/.zshrc && \
    echo '  echo "|_| \\_\\/_/   \\_\\_____|_|   |_| |_|"' >> /home/node/.zshrc && \
    echo '  echo ""' >> /home/node/.zshrc && \
    echo '  RALPH_VERSION=$(ralph --version 2>/dev/null | head -1 || echo "unknown")' >> /home/node/.zshrc && \
    echo '  echo "CLI - Version $RALPH_VERSION"' >> /home/node/.zshrc && \
    echo '  echo ""' >> /home/node/.zshrc && \
    echo 'fi' >> /home/node/.zshrc

# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION}

# Install ralph-cli-claude from npm registry
RUN npm install -g ralph-cli-claude

# Node.js already included in base image

# Setup sudo only for firewall script (no general sudo for security)
RUN echo "node ALL=(ALL) NOPASSWD: /usr/local/bin/init-firewall.sh" >> /etc/sudoers.d/node-firewall

# Create directories
RUN mkdir -p /workspace && chown node:node /workspace
RUN mkdir -p /home/node/.claude && chown node:node /home/node/.claude
RUN mkdir -p /commandhistory && chown node:node /commandhistory

# Copy firewall script
COPY init-firewall.sh /usr/local/bin/init-firewall.sh
RUN chmod +x /usr/local/bin/init-firewall.sh

# Set environment variables
ENV DEVCONTAINER=true
ENV NODE_OPTIONS="--max-old-space-size=4096"
ENV CLAUDE_CONFIG_DIR="/home/node/.claude"
ENV SHELL=/bin/zsh
ENV EDITOR=nano

# Add bash aliases and prompt (fallback if using bash)
RUN echo 'alias ll="ls -la"' >> /etc/bash.bashrc && \
    echo 'PS1="\[\033[43;30m\][ralph]\w\[\033[0m\]\$ "' >> /etc/bash.bashrc

# Switch to non-root user
USER node
WORKDIR /workspace

# Default to zsh
CMD ["zsh"]
